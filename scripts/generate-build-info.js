#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const outputPath = path.join(__dirname, '..', 'src', 'shared', 'build-info.ts');

function getGitInfo() {
  try {
    const branch = execSync('git rev-parse --abbrev-ref HEAD', { encoding: 'utf8' }).trim();
    const sha = execSync('git rev-parse --short HEAD', { encoding: 'utf8' }).trim();
    const fullSha = execSync('git rev-parse HEAD', { encoding: 'utf8' }).trim();
    return { branch, sha, fullSha };
  } catch (e) {
    return { branch: 'unknown', sha: 'unknown', fullSha: 'unknown' };
  }
}

function getBuildTime() {
  return new Date().toISOString();
}

function getOAuthConfig() {
  /**
   * GitHub OAuth App credentials for localmost.
   *
   * SECURITY NOTE: These are intentionally PUBLIC values, not secrets.
   * - Client IDs are visible in OAuth authorization URLs by design
   * - GitHub's OAuth Device Flow (used by localmost) doesn't use client secrets
   * - Users authenticate directly with GitHub, not with these credentials
   *
   * These values identify the localmost app to GitHub. Changing them would
   * require users to re-authorize the application.
   */
  return {
    clientId: 'Iv23lihPo2hYyq9YVvjp',
    oauthAppId: 'Ov23lif1XN6j64zu1IFh',
  };
}

const gitInfo = getGitInfo();
const buildTime = getBuildTime();
const oauthConfig = getOAuthConfig();

const content = `// Auto-generated by scripts/generate-build-info.js
// Do not edit manually

export const BUILD_INFO = {
  buildTime: '${buildTime}',
  branch: '${gitInfo.branch}',
  sha: '${gitInfo.sha}',
  fullSha: '${gitInfo.fullSha}',
} as const;

/**
 * GitHub OAuth App credentials for localmost.
 * These are PUBLIC values (not secrets) - visible in OAuth URLs by design.
 * See scripts/generate-build-info.js for details.
 */
export const OAUTH_CONFIG = {
  clientId: '${oauthConfig.clientId}',
  oauthAppId: '${oauthConfig.oauthAppId}',
} as const;
`;

fs.writeFileSync(outputPath, content);
console.log(`Generated build info: branch=${gitInfo.branch}, sha=${gitInfo.sha}`);
